<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/principal"></ion-back-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button id="open-suggestions-modal" [disabled]="shoppingService.suggestedProducts().length === 0">
        <ion-icon slot="icon-only" name="bulb-outline"></ion-icon>
      </ion-button>
      <ion-button (click)="clearList()" [disabled]="shoppingService.items().length === 0">
        <ion-icon slot="icon-only" name="trash-outline" class="clear-icon"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>
      Lista de Compra
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="page-content">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Lista de Compra</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- List Section -->
  <div class="list-container">
    <ion-list lines="none" style="background: transparent;">
      <ion-item-sliding *ngFor="let item of shoppingService.items()" class="shopping-item-sliding">
        <ion-item class="shopping-item-card" [class.favorite-item-card]="item.isFavorite">
          <ion-checkbox slot="start" mode="ios" color="secondary" [checked]="selectedItems().includes(item.id)"
            (ionChange)="toggleSelection(item.id)"></ion-checkbox>

          <ion-label (click)="openEditModal(item)">
            <div class="item-name-row">
              <h2 [class.completed-text]="selectedItems().includes(item.id)">{{ item.name }}</h2>
              <ion-badge color="warning" *ngIf="item.isFavorite" class="favorite-badge">TOP</ion-badge>
            </div>
            <p>Cant: <strong>{{ item.quantity }}</strong> &nbsp;|&nbsp; Est: {{ item.price | currency:'EUR' }}</p>
            <p class="unit-price" *ngIf="item.weight && item.weight > 0">
              {{ (item.price || 0) / item.weight | currency:'EUR' }}/kg
            </p>
          </ion-label>
          <ion-chip slot="end" color="tertiary" outline="true">
            <ion-icon name="cash-outline"></ion-icon>
            <ion-label>{{ (item.price || 0) * item.quantity | currency:'EUR' }}</ion-label>
          </ion-chip>

          <ion-button slot="end" fill="clear" class="favorite-btn ion-no-margin"
            (click)="toggleFavorite($event, item.id)">
            <ion-icon [name]="item.isFavorite ? 'heart' : 'heart-outline'"
              [color]="item.isFavorite ? 'danger' : 'medium'"></ion-icon>
          </ion-button>
        </ion-item>

        <ion-item-options side="end">
          <ion-item-option color="danger" (click)="deleteItem(item.id)">
            <ion-icon name="trash" slot="icon-only"></ion-icon>
          </ion-item-option>
        </ion-item-options>
      </ion-item-sliding>
    </ion-list>
  </div>

  <!-- Empty State -->
  <div *ngIf="shoppingService.items().length === 0" class="empty-state">
    <ion-icon name="basket-outline" color="medium"></ion-icon>
    <h3>Tu lista está vacía</h3>
    <p>¡Empieza a añadir cosas ricas!</p>
  </div>

  <!-- Add Button FAB -->
  <ion-fab vertical="bottom" horizontal="center" slot="fixed" *ngIf="selectedItems().length === 0">
    <ion-fab-button (click)="openAddModal()" color="secondary" class="add-fab">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Checkout and Delete Buttons -->
  <ion-fab vertical="bottom" horizontal="start" slot="fixed" *ngIf="selectedItems().length > 0">
    <ion-fab-button (click)="deleteSelected()" color="danger" class="checkout-fab">
      <ion-icon name="trash"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="selectedItems().length > 0">
    <ion-fab-button (click)="checkout()" color="success" class="checkout-fab">
      <ion-icon name="cart"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Add Product Modal -->
  <ion-modal [isOpen]="isAddModalOpen" (didDismiss)="closeAddModal()" [initialBreakpoint]="0.7"
    [breakpoints]="[0, 0.7, 0.95]">
    <ng-template>
      <ion-header>
        <ion-toolbar color="secondary">
          <ion-title>Añadir Producto</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeAddModal()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding modal-content">
        <ion-card class="ion-no-margin" style="border-radius: 16px; margin-bottom: 20px;">
          <ion-card-content>
            <ion-item lines="none" class="input-item">
              <ion-input label="Nombre del Producto" labelPlacement="stacked" [(ngModel)]="newItemName"
                placeholder="ej. Leche, Pan..." autofocus="true"></ion-input>
            </ion-item>

            <ion-grid class="ion-no-padding">
              <ion-row>
                <ion-col size="4">
                  <ion-item lines="none" class="input-item">
                    <ion-input label="Cant." labelPlacement="stacked" type="number" [(ngModel)]="newItemQuantity"
                      placeholder="1"></ion-input>
                  </ion-item>
                </ion-col>
                <ion-col size="4">
                  <ion-item lines="none" class="input-item">
                    <ion-input label="Precio (€)" labelPlacement="stacked" type="number" [(ngModel)]="newItemPrice"
                      placeholder="0.00"></ion-input>
                  </ion-item>
                </ion-col>
                <ion-col size="4">
                  <ion-item lines="none" class="input-item">
                    <ion-input label="Peso (kg)" labelPlacement="stacked" type="number" [(ngModel)]="newItemWeight"
                      placeholder="0.00"></ion-input>
                  </ion-item>
                </ion-col>
              </ion-row>
            </ion-grid>

            <ion-button expand="block" (click)="addItem()" [disabled]="!newItemName" class="add-btn ion-margin-top"
              color="secondary" shape="round">
              <ion-icon name="add-circle-outline" slot="start"></ion-icon>
              Añadir a la lista
            </ion-button>
          </ion-card-content>
        </ion-card>

        <!-- Previous Products Section -->
        <div class="history-suggestions" *ngIf="shoppingService.suggestedProducts().length > 0">
          <ion-list-header>
            <ion-label>Productos Anteriores</ion-label>
          </ion-list-header>
          <ion-list class="suggestions-list" lines="full">
            <ion-item *ngFor="let prod of shoppingService.suggestedProducts()" class="suggestion-item">
              <ion-button slot="start" fill="clear"
                (click)="toggleSuggestionFavorite($event, prod.name, prod.isFavorite)">
                <ion-icon [name]="prod.isFavorite ? 'heart' : 'heart-outline'"
                  [color]="prod.isFavorite ? 'danger' : 'medium'"></ion-icon>
              </ion-button>
              <ion-label (click)="addSuggestedProduct(prod)">
                <div class="item-name-row">
                  <h3 [style.font-weight]="prod.isFavorite ? '700' : '500'">{{ prod.name }}</h3>
                  <ion-icon name="star-outline" color="warning" *ngIf="prod.isFavorite"
                    style="font-size: 0.9rem; margin-left: 5px;"></ion-icon>
                </div>
                <p>{{ prod.quantity }} un. | {{ prod.price | currency:'EUR' }} | {{ prod.weight }} kg</p>
              </ion-label>
              <ion-button slot="end" fill="clear" (click)="addSuggestedProduct(prod)">
                <ion-icon name="add-circle" color="secondary"></ion-icon>
              </ion-button>
            </ion-item>
          </ion-list>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Edit Modal (similar to History) -->
  <ion-modal [isOpen]="isEditModalOpen" (didDismiss)="closeEditModal()" [initialBreakpoint]="0.5"
    [breakpoints]="[0, 0.5, 0.75]">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>Editar {{ editingItemName }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeEditModal()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding edit-modal-content">
        <div class="edit-form">
          <ion-item class="edit-input-item">
            <ion-label position="stacked">Precio (€)</ion-label>
            <ion-input type="number" [(ngModel)]="editPrice" placeholder="0.00"></ion-input>
          </ion-item>

          <ion-item class="edit-input-item">
            <ion-label position="stacked">Peso (kg)</ion-label>
            <ion-input type="number" [(ngModel)]="editWeight" placeholder="0.00"></ion-input>
          </ion-item>

          <ion-item class="edit-input-item">
            <ion-label position="stacked">Cantidad</ion-label>
            <ion-input type="number" [(ngModel)]="editQuantity" placeholder="1"></ion-input>
          </ion-item>

          <ion-button expand="block" (click)="saveEdit()" class="save-btn ion-margin-top" color="success" shape="round">
            <ion-icon name="save-outline" slot="start"></ion-icon>
            Guardar Cambios
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <ion-modal trigger="open-suggestions-modal" #suggestionsModal [initialBreakpoint]="0.5"
    [breakpoints]="[0, 0.5, 0.75, 1.0]">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>Productos Frecuentes</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="suggestionsModal.dismiss()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <p class="suggestions-hint">Toca un producto para volver a añadirlo a tu lista actual.</p>
        <div class="suggestions-grid">
          <ion-chip *ngFor="let prod of shoppingService.suggestedProducts()" (click)="addSuggestedProduct(prod)"
            class="suggestion-chip">
            <ion-icon [name]="prod.isFavorite ? 'heart' : 'add-outline'"
              [color]="prod.isFavorite ? 'danger' : 'primary'"></ion-icon>
            <ion-label>{{ prod.name }}</ion-label>
          </ion-chip>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>